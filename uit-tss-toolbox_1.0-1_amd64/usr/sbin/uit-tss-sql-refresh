#!/bin/bash

for tagNum in $(mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" \
		-s -N --execute="SELECT tagnumber FROM jobstats;"); do

	exists=$(mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" -s -N --execute="\
		SELECT tagnumber FROM clientstats WHERE tagnumber = '${tagNum}';")

		if [[ $exists == $tagNum ]]; then
			mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" -s -N --execute="\
    			UPDATE clientstats \
     			SET tagnumber = '${tagNum}' \
    			WHERE tagnumber = '${tagNum}';"
		else
			mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" -s -N --execute="\
				INSERT INTO clientstats(\
				tagnumber, \
				all_lastdate, \
				all_lastuuid, \
				all_time, \
				all_avgtime, \
				all_avgtimetoday, \
				erase_avgtime, \
				erase_avgtimetoday, \
				clone_avgtime, \
				clone_avgtimetoday, \
				all_jobs, \
				all_jobstoday, \
				erase_jobs, \
				erase_jobstoday, \
				clone_jobs, \
				clone_jobstoday)
				VALUES (
				'${tagNum}', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \
				'0', \);"
		fi

	# Update totaltime
	erasetime=$(mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" \
		-s -N --execute="SELECT erase_time FROM jobstats WHERE tagnumber = '${tagNum}';")
	erasetime=$(z=0; for i in ${erasetime}; do z=$(( z + i )); echo $z; done | tail -n 1)
	imagetime=$(mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" \
		-s -N --execute="SELECT clone_time FROM jobstats WHERE tagnumber = '${tagNum}';")
	imagetime=$(z=0; for i in ${imagetime}; do z=$(( z + i )); echo $z; done | tail -n 1)
	
	totaltime=$(( erasetime + imagetime ))
    mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" \
		-s -N --execute="UPDATE clientstats SET all_time = '${totaltime}' WHERE tagnumber = '${tagNum}';"



    # Average image and erase time overall
	sqlstatement=$(mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" \
		-s -N --execute="SELECT all_time FROM clientstats WHERE tagnumber = ${tagNum};")

	linecount=$(echo "${sqlstatement}" | wc -l )

	totaltime=$(echo "${sqlstatement}" | tail -n 1)

	TimesSeconds=$((totaltime / linecount))

	TimesMinutes=$(echo "$((TimesSeconds / 60)) minutes")

	mysql --user="laptops" --password="UHouston!" --database="laptopDB" --host="10.0.0.1" --execute="\
		UPDATE clientstats SET all_avgtime = '${TimesMinutes}' WHERE tagnumber = ${tagNum};"

done