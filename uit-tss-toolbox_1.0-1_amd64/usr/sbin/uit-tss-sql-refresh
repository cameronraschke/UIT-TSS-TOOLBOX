#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/DB-connect-local.php');

$date = date('Y-m-d',time());
$time = date('Y-m-d H:i:s', time());

##### clientstats #####
$sql = "SELECT tagnumber FROM jobstats WHERE NOT tagnumber = '000000'";
$results = $conn->query($sql);
$i = $results->fetch_all(MYSQLI_ASSOC);
foreach ($i as $key => $value) {
    unset($tagNum);
    global $tagNum;
    $tagNum = $value['tagnumber'];
    echo "Working on laptop: " . $tagNum . PHP_EOL;

    $sql = "SELECT tagnumber FROM clientstats WHERE tagnumber = '$tagNum'";
    $results = $conn->query($sql);
    $exists = mysqli_num_rows($results);
    if ($exists == "0") {
        echo "Inserting laptop: " . $tagNum . PHP_EOL;
        $sql = "INSERT INTO clientstats(tagnumber,device_type,last_job_date,all_lastuuid,all_time,all_avgtime,";
        $sql .= "erase_time,erase_avgtime,clone_time,clone_avgtime,all_jobs,erase_jobs,clone_jobs,disk)";
        $sql .= "VALUES ($tagNum,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT)";
        $conn->query($sql);
    }

    #Update disks
    $sql = "SELECT disk FROM jobstats WHERE tagnumber = '$tagNum'";
    $disks = $conn->query($sql);
    while ($row = $disks->fetch_array(MYSQLI_ASSOC)) {
        $sql = "UPDATE clientstats SET disk = '" . $row['disk'] . "' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
    }

    # Erase times
    $sql = "SELECT erase_time FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'";
    $results = $conn->query($sql);
    $eraseLineCount = mysqli_num_rows($results);
    $sql = "SELECT ROUND(SUM(erase_time), 2) AS erase_time FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'";
    $results = $conn->query($sql);
    $i = $results->fetch_all(MYSQLI_ASSOC);
    $eraseTime = 0;
    foreach($i as $key => $value) {
        $eraseTime = $eraseTime + $value['erase_time'];
    }
    # Update total erase jobs
    $sql = "UPDATE clientstats SET erase_jobs = '$eraseLineCount' WHERE tagnumber = '$tagNum'";
    $conn->query($sql);

    if ($eraseLineCount >= 1) {
        $sql = "UPDATE clientstats SET erase_time = '$eraseTime' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
        # Avg. Times
        $avgTimeSec = round($eraseTime / $eraseLineCount);
        $avgTimeMin = round($avgTimeSec / 60) . " minutes";
        $sql = "UPDATE clientstats SET erase_avgtime = '$avgTimeMin' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
    }

    # Clone times
    $sql = "SELECT clone_time FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'";
    $results = $conn->query($sql);
    $cloneLineCount = mysqli_num_rows($results);
    $sql = "SELECT ROUND(SUM(clone_time), 2) AS clone_time FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'";
    $results = $conn->query($sql);
    $i = $results->fetch_all(MYSQLI_ASSOC);
    $cloneTime = 0;
    foreach($i as $key => $value) {
        $cloneTime = $cloneTime + $value['clone_time'];
    }
    # Update total clone jobs
    $sql = "UPDATE clientstats SET clone_jobs = '$cloneLineCount' WHERE tagnumber = '$tagNum'";
    $conn->query($sql);

    if ($cloneLineCount >= 1) {
        $sql = "UPDATE clientstats SET clone_time = '$cloneTime' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
        # Avg. Times
        $avgTimeSec = round($cloneTime / $cloneLineCount);
        $avgTimeMin = round($avgTimeSec / 60) . " minutes";
        $sql = "UPDATE clientstats SET clone_avgtime = '$avgTimeMin' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
    }


    # All (clone + erase) times
    $sql = "SELECT all_time FROM jobstats WHERE tagnumber = '$tagNum' AND (erase_completed = 'Yes' OR clone_completed = 'Yes')";
    $results = $conn->query($sql);
    $allLineCount = mysqli_num_rows($results);
    $sql = "SELECT ROUND(SUM(erase_time + clone_time), 2) AS all_time FROM jobstats WHERE tagnumber = '$tagNum' AND (erase_completed = 'Yes' OR clone_completed = 'Yes')";
    $results = $conn->query($sql);
    $i = $results->fetch_all(MYSQLI_ASSOC);
    $allTime = 0;
    foreach($i as $key => $value) {
        $allTime = $allTime + $value['all_time'];
    }
    # Update total jobs
    $sql = "UPDATE clientstats SET all_jobs = '$allLineCount' WHERE tagnumber = '$tagNum'";
    $conn->query($sql);
    #Avg Times
    if ($allLineCount >= 1) {
        $sql = "UPDATE clientstats SET all_time = '$allTime' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
        # Avg. Times
        $avgTimeSec = round($allTime / $allLineCount);
        $avgTimeMin = round($avgTimeSec / 60) . " minutes";
        $sql = "UPDATE clientstats SET all_avgtime = '$avgTimeMin' WHERE tagnumber = '$tagNum'";
        $conn->query($sql);
    }
    # Dates
    $sql = "SELECT date FROM jobstats WHERE tagnumber = '$tagNum' ORDER BY date DESC LIMIT 1";
    $results = $conn->query($sql);
    $i = $results->fetch_all(MYSQLI_ASSOC);
    foreach($i as $key => $value) {
        $lastDate = $value['date'];
    }
    $sql = "UPDATE clientstats SET last_job_date = '$lastDate' WHERE tagnumber = '$tagNum'";
    $conn->query($sql);
    }
    # Device Type
    $sql = "SELECT clone_image FROM jobstats WHERE tagnumber = '$tagNum'";
    $results = $conn->query($sql);
    $i = $results->fetch_all(MYSQLI_ASSOC);
    foreach($i as $key => $value) {
        $deviceType = $value['clone_image'];
        if (preg_match('/.*HP.*/',"$deviceType",$matches)) {
            $sql = "UPDATE clientstats SET device_type = 'HP' WHERE tagnumber = '$tagNum'";
            $conn->query($sql);
        } else {
            $sql = "UPDATE clientstats SET device_type = 'Dell' WHERE tagnumber = '$tagNum'";
            $conn->query($sql);
        }
    }



##### serverstats #####
# Update date of report, create new report if none exist for today
$sql = "SELECT date FROM serverstats WHERE date = '$date'";
$results = $conn->query($sql);
while ($row = $results->fetch_array(MYSQLI_ASSOC)) {
    $sqldate = $row['date'];
}
if (empty($sqldate)) {
    $sql = "INSERT INTO serverstats(date,laptop_count,last_image_update,all_jobs,clone_jobs,erase_jobs,";
    $sql .= "all_avgtime,clone_avgtime,nvme_erase_avgtime,ssd_erase_avgtime) VALUES ('$date',";
    $sql .= "'N/A','N/A','N/A','N/A','N/A','N/A','N/A','N/A','N/A')";
    $conn->query($sql);
}

# Update laptop count
$sql = "SELECT tagnumber FROM clientstats WHERE NOT tagnumber = '000000'";
$results = $conn->query($sql);
$laptopCount = mysqli_num_rows($results);
$sql = "UPDATE serverstats SET laptop_count = '$laptopCount' WHERE date = '$date'";
$conn->query($sql);


# Update clone_avgtime
$sql = "SELECT ROUND(SUM(clone_avgtime), 2) AS clone_avgtime FROM clientstats WHERE NOT tagnumber = '000000' AND NOT clone_avgtime = '0 minutes'";
$results = $conn->query($sql);
$i = $results->fetch_all(MYSQLI_ASSOC);
$cloneAvgTime = "0";
foreach($i as $key => $value) {
    $cloneAvgTime = $cloneAvgTime + $value['clone_avgtime'];
}
if ($cloneLineCount >= 1) {
    $avgTimeSec = round($cloneTime / $cloneLineCount);
    $avgTimeMin = round($avgTimeSec / 60) . " minutes";
    $sql = "UPDATE serverstats SET clone_avgtime = '$avgTimeMin' WHERE date = '$date'";
    $conn->query($sql);
}


# Update nvme_erase_avgtime
$sql = "SELECT erase_avgtime FROM clientstats WHERE NOT tagnumber = '000000' AND NOT erase_avgtime = '0 minutes' AND disk LIKE 'nvme0%'";
$results = $conn->query($sql);
$nvmeEraseLineCount = mysqli_num_rows($results);
$sql = "SELECT ROUND(SUM(erase_avgtime), 2) AS nvme_erase_avgtime FROM clientstats WHERE NOT tagnumber = '000000' AND NOT erase_avgtime = '0 minutes' AND disk LIKE 'nvme0%'";
$results = $conn->query($sql);
$i = $results->fetch_all(MYSQLI_ASSOC);
$nvmeEraseAvgTime = 0;
foreach($i as $key => $value) {
    $nvmeEraseAvgTime = $nvmeEraseAvgTime + $value['nvme_erase_avgtime'];
}
if ($nvmeEraseLineCount >= 1) {
    $avgTimeSec = round($nvmeEraseAvgTime / $nvmeEraseLineCount);
    $avgTimeMin = round($avgTimeSec) . " minutes";
    $sql = "UPDATE serverstats SET nvme_erase_avgtime = '$avgTimeMin' WHERE date = '$date'";
    $conn->query($sql);
}

# Update ssd_erase_avgtime
$sql = "SELECT erase_avgtime FROM clientstats WHERE NOT tagnumber = '000000' AND NOT erase_avgtime = '0 minutes' AND disk LIKE 'sd%'";
$results = $conn->query($sql);
$ssdEraseLineCount = mysqli_num_rows($results);
$sql = "SELECT ROUND(SUM(erase_avgtime), 2) AS ssd_erase_avgtime FROM clientstats WHERE NOT tagnumber = '000000' AND NOT erase_avgtime = '0 minutes' AND disk LIKE 'sd%'";
$results = $conn->query($sql);
$i = $results->fetch_all(MYSQLI_ASSOC);
$ssdEraseAvgTime = 0;
foreach($i as $key => $value) {
    $ssdEraseAvgTime = $ssdEraseAvgTime + $value['ssd_erase_avgtime'];
}
if ($ssdEraseLineCount >= 1) {
    $avgTimeSec = round($ssdEraseAvgTime / $ssdEraseLineCount);
    $avgTimeMin = round($avgTimeSec) . " minutes";
    $sql = "UPDATE serverstats SET ssd_erase_avgtime = '$avgTimeMin' WHERE date = '$date'";
    $conn->query($sql);
}

# Update erase_jobs
$sql = "SELECT erase_jobs FROM clientstats WHERE NOT tagnumber = '000000' AND erase_completed = 'Yes'";
$results = $conn->query($sql);
$eraseJobsLineCount = mysqli_num_rows($results);
$results = $conn->query($sql);
while ($row = $results->fetch_array(MYSQLI_ASSOC)) {
    $sql = "UPDATE serverstats SET erase_jobs = '$eraseJobsLineCount'";
    $conn->query($sql);
}

# Update clone_jobs
$sql = "SELECT clone_jobs FROM clientstats WHERE NOT tagnumber = '000000' AND clone_completed = 'Yes'";
$results = $conn->query($sql);
$cloneJobsLineCount = mysqli_num_rows($results);
$results = $conn->query($sql);
while ($row = $results->fetch_array(MYSQLI_ASSOC)) {
    $sql = "UPDATE serverstats SET clone_jobs = '$cloneJobsLineCount'";
    $conn->query($sql);
}

# Update all_jobs
$sql = "SELECT ROUND(SUM(erase_jobs + clone_jobs), 2) AS all_jobs FROM clientstats WHERE NOT tagnumber = '000000' AND (erase_completed = 'Yes' OR clone_completed = 'Yes')";
$results = $conn->query($sql);
while ($row = $results->fetch_array(MYSQLI_ASSOC)) {
    $allJobsCount = $row['all_jobs'];
    $sql = "UPDATE serverstats SET all_jobs = '$allJobsCount'";
    $conn->query($sql);
}

$conn->close();
?>