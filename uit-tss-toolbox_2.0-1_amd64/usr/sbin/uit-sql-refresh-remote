#!/usr/bin/php
<?php
# Connect to database and include custom functions
include('/var/lib/UIT-TSS-TOOLBOX/include.php');

$timer = new scriptTimer();

echo "Updating remote table" . PHP_EOL;
$timer->start();

$db = new db();

$db->select("SELECT remote.tagnumber,
jobstats.time,
IF(TIME_TO_SEC(TIMEDIFF(NOW(), remote.present)) < 45, '1', '0') AS 'present_bool',
(CASE
  WHEN static_bios_stats.bios_version = jobstats.bios_version THEN '1'
  ELSE '0'
END
) AS 'bios_updated',
t1.last_job_time,
(CASE
  -- WHEN t1.erase_completed = 1 AND t1.clone_completed = 1 THEN '1'
  WHEN t1.erase_completed = 1 AND t1.clone_completed IS NULL THEN '0'
  -- WHEN t1.erase_completed IS NULL AND t1.clone_completed = 1 THEN '1'
  ELSE '1'
END) AS 'os_installed',
remote.disk_temp
FROM remote
LEFT JOIN jobstats ON jobstats.tagnumber = remote.tagnumber
INNER JOIN system_data ON system_data.tagnumber = remote.tagnumber
INNER JOIN static_bios_stats ON static_bios_stats.system_model = system_data.system_model
LEFT JOIN (SELECT tagnumber, MAX(time) AS 'last_job_time', erase_completed, clone_completed FROM jobstats WHERE tagnumber IS NOT NULL AND (erase_completed = 1 OR clone_completed = 1) GROUP BY tagnumber) t1 ON t1.tagnumber = remote.tagnumber
WHERE jobstats.tagnumber IS NOT NULL 
AND jobstats.department IS NOT NULL
AND jobstats.time IN (SELECT MAX(time) FROM jobstats WHERE bios_version IS NOT NULL GROUP BY tagnumber)
GROUP BY tagnumber
ORDER BY jobstats.time DESC");


foreach ($db->get() as $key => $value) {

  echo PHP_EOL;
  $timer->startMarker();

  # If tagnumber does not exist in the remote table, insert it.
  $db->Pselect("SELECT tagnumber FROM remote WHERE tagnumber = :tagnumber", array(':tagnumber' => $value["tagnumber"]));
    if (is_array($db->get()) === FALSE) {
      $db->insertRemote($value["tagnumber"]);
    }

  // Update presence
  $db->updateRemote($value["tagnumber"], "present_bool", $value["present_bool"]);

  // Update BIOS updated status
  $db->updateRemote($value["tagnumber"], "bios_updated", $value["bios_updated"]);

  // Update Last Job Time
  $db->updateRemote($value["tagnumber"], "last_job_time", $value["last_job_time"]);

  // Disk Temp
  if ($value["disk_temp"] >= "82") {
    $db->updateRemote($value["tagnumber"], "status", "fail - high disk temp");
    $db->updateRemote($value["tagnumber"], "task", "shutdown");
  }

  // OS Installed?
  $db->updateRemote($value["tagnumber"], "os_installed", $value["os_installed"]);

  echo "Time taken to update " . $value["tagnumber"] . ": " . $timer->endMarker() . "s" . PHP_EOL;
}

echo "(Updated) remote: " . $timer->end() . " seconds" . PHP_EOL;

?>