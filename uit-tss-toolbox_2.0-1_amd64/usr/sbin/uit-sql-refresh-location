#!/usr/bin/php
<?php

# Connect to database and include custom functions
include('/var/lib/UIT-TSS-TOOLBOX/mysql-functions');

# Set current date and time
$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

echo "Updating the location table" . PHP_EOL;

# Iterate through distinct tagnumbers from jobstats with techComm UUIDs
dbSelect("SELECT DISTINCT tagnumber FROM jobstats WHERE uuid LIKE 'techComm-%'");
foreach ($arr as $key => $value) {
    # Start the timer
    $start = hrtime(true);

    $tagNum = $value['tagnumber'];

    # Get the most recent serial number from jobstats that is associated with the tagnumber.
    dbSelectVal("SELECT system_serial AS result FROM jobstats WHERE tagnumber = '$tagNum' AND system_serial IS NOT NULL ORDER BY time DESC LIMIT 1");
    $serial = $result;
    dbUpdateLoc("system_serial", "$result", "$tagNum");

    /* Select the time of the most recent entry for a given client where the clone job has successfully completed. 
    This shows whether or not the OS is installed and at what time it was last installed. */
    $sql = "SELECT time FROM jobstats WHERE time IN (SELECT MAX(time) AS result FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes') ORDER BY time DESC LIMIT 1";
    dbUpdateLoc("os_installed", "$result", "$tagNum");

    # End the timer and print how long it took to update the location table for a specific tagnumber.
    $end = hrtime(true);
    $executionTime = round(($end - $start) / 1e9, 4);
    if (filter($serial) == 0) {
        echo "Updating location for $tagNum ($serial): " . $executionTime . " seconds" . PHP_EOL;
    } else {
        echo "Can't find serial for $tagNum: " . $executionTime . " seconds" . PHP_EOL;
    }
}

# Close the connection to the DB.
$pdo = null;
?>