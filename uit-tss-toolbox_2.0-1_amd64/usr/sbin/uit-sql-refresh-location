#!/usr/bin/php
<?php

# Connect to database and include custom functions
include('/var/lib/UIT-TSS-TOOLBOX/include.php');

$timer = new scriptTimer();

# Start the timer
echo "Updating locations" . PHP_EOL;
$timer->start();

$db = new db();
# Iterate through distinct tagnumbers from jobstats with techComm UUIDs
$db->select("SELECT
  jobstats.tagnumber, 
  (CASE
    WHEN locations.disk_removed = 1 THEN '0'
    WHEN jobstats.erase_completed = 1 AND jobstats.clone_completed = 1 THEN '1'
    WHEN jobstats.erase_completed = 1 AND jobstats.clone_completed IS NULL THEN '0'
    WHEN jobstats.erase_completed IS NULL AND jobstats.clone_completed = 1 THEN '1'
    ELSE '1'
  END) AS 'os_installed',
  MAX(locations.time) AS 'max_time'
  FROM jobstats
  INNER JOIN locations ON jobstats.tagnumber = locations.tagnumber
  WHERE (jobstats.clone_completed = 1 OR jobstats.erase_completed = 1)
  GROUP BY jobstats.tagnumber
  ORDER BY jobstats.time, locations.time DESC");
  
foreach ($db->get() as $key => $value) {

  # Start the timer that counts how much time each tagnumber takes to process.
  echo PHP_EOL;
  $timer->startMarker();

  $db->updateLocation("os_installed", $value["os_installed"], $value["max_time"]);

  # End the timer and print how long it took to update the location table for a specific tagnumber.
  # End the marker timer
  echo "Time taken to update " . $value["tagnumber"] . ": " . $timer->endMarker() . "s" . PHP_EOL;
}

# Stop the timer
echo "(Updated) locations: " . $timer->end() . " seconds" . PHP_EOL;
?>