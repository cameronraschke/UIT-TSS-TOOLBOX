#!/usr/bin/php
<?php
require('/var/www/html/uit-web/php/include.php');

$db = new dbPSQL();


$file = new SplFileObject("/tmp/uit-tmp-reports/checkout-report-" . $date . ".csv", "w");
$db->select("SELECT 'Tag Number', 'Customer Name', 'Checkout Date', 'Return Date', 'Note'");
foreach ($db->get() as $key => $value) {
    $file->fputcsv($value);
}
unset($value);

$db->AssocSelect("SELECT tagnumber, customer_name, checkout_date, return_date, note FROM (SELECT checkouts.tagnumber, checkouts.customer_name, checkouts.checkout_date, checkouts.return_date, checkouts.note,
    checkouts.checkout_bool,
    ROW_NUMBER() OVER (PARTITION BY tagnumber ORDER BY time DESC) AS row_nums 
    FROM checkouts) t1
    WHERE (t1.checkout_date IS NOT NULL OR t1.return_date IS NOT NULL)
        AND t1.row_nums <= 1 AND NOT t1.row_nums IS NULL AND t1.checkout_bool = TRUE 
    ORDER BY t1.customer_name ASC, t1.checkout_date DESC, t1.tagnumber DESC");
foreach ($db->get() as $key => $value) {
    $file->fputcsv($value);
}
unset($value);
$file = null;

?>