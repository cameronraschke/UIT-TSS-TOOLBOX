#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/PDO-connect');

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d-His');



#Job Table
$sql = "SELECT 'Job UUID','Tag Number','Ethernet Address','WiFi Address','Date','Datetime','BIOS Vendor','BIOS Version','BIOS Last Update',";
$sql .= "'BIOS Revision','BIOS Firmware','System Manufacturer','System Product Name','System Serial Number','System UUID',";
$sql .= "'System SKU','System Family','Motherboard Manufacturer','Motherboard Serial Number','Chassis Manufcaturer',";
$sql .= "'Chassis Type','Chassis Serial','Chassis Tag','PSU State','CPU Family','CPU Manufacturer','CPU ID',";
$sql .= "'CPU Version','CPU Voltage','CPU Max Speed','CPU Current Speed','CPU Architecture','CPU Cores','CPU Threads','CPU Temp','RAM Serial','Battery Manufacturer',";
$sql .= "'Battery Name','Battery Capacity','Battery Voltage','Battery Serial Number','Battery Manufacture Date','Battery Alarm (Boolean)','Battery Max Charge %','Battery Charge Cycles','Boot Errors',";
$sql .= "'Boot Time','Job Type','Did Sleep (Boolean)','Disk','Disk Type','Disk Size (GB)','Disk Model','Disk Serial','Disk Firmware','Disk Health Check','Disk Power on Hours','Disk Temperature','Disk Reads (TB)','Disk Writes (TB)',";
$sql .= "'Total Time for Jobs','Erase Successful','Erase Mode','Total Erase Time','Percent of Disk Erased',";
$sql .= "'Clone Successful','Clone Mode','Total Clone Time','Master Image','Clone Server','Clone Image','Last Image Update','Kernel Version' ";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $file = new SplFileObject("/tmp/laptop-report-job-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}

$sql = "SELECT * FROM jobstats WHERE uuid LIKE 'techComm-%' ORDER BY date DESC";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $file = new SplFileObject("/tmp/laptop-report-job-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}



#Server Table
unset($arr);
unset($row);
$sql = "SELECT date,laptop_count,CONCAT(tbw_pcnt, '%'),CONCAT(battery_health, '%'),all_jobs,clone_jobs,erase_jobs,";
$sql .= "CONCAT(clone_avgtime, ' minutes'),CONCAT(nvme_erase_avgtime, ' minutes'),CONCAT(sata_erase_avgtime, ' minutes'),last_image_update ";
$sql .= "FROM serverstats ORDER BY date DESC";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $arr[] = $row;
}

$sql = "SELECT 'Date','Computer Count','Disk Wear','Battery Max Charge Level','Total Erase and Clone Jobs','Clone Jobs','Erase Jobs',";
$sql .= "'Clone Time','NVME Erase Time','SATA Erase Time','Last Image Update'";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $file = new SplFileObject("/tmp/laptop-report-server-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}

foreach ($arr as $row) {
    $file = new SplFileObject("/tmp/laptop-report-server-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}



#Client Table
unset($arr);
unset($row);
$sql = "SELECT tagnumber,system_serial,device_type,system_productname,last_job_date,";
$sql .= "os_installed,CONCAT(battery_health, '%'),CONCAT(tbw_pcnt, '%'),";
$sql .= "CONCAT(erase_avgtime, ' minutes'),CONCAT(clone_avgtime, ' minutes'),all_jobs ";
$sql .= "FROM clientstats ORDER BY 'last_job_date' DESC";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $arr[] = $row;
}

$sql = "SELECT 'Tag Number','Serial Number','Device Manufacturer','Device Model','Last Job Date',";
$sql .= "'OS Installed','Battery Max Charge','Terabytes Written (TBW)',";
$sql .= "'Erase Time','Clone Time','Total Jobs'";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $file = new SplFileObject("/tmp/laptop-report-client-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}


foreach ($arr as $row) {
        $file = new SplFileObject("/tmp/laptop-report-client-".$time.".csv", 'a');
        $file->fputcsv($row);
        $file = null;
}



#Locations Table
unset($arr);
unset($row);
$sql = "SELECT DISTINCT tagnumber FROM locations";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $arr[] = $row['tagnumber'];
}

$sql = "SELECT 'Tagnumber', 'Serial Number', 'Location', 'Status', 'Description of Problem', 'Most Recent Update'";
foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
    $file = new SplFileObject("/tmp/laptop-report-location-".$time.".csv", 'a');
    $file->fputcsv($row);
    $file = null;
}


foreach ($arr as $row) {
    unset($tagNum);
    $tagNum = $row;
    $sql = "SELECT tagnumber,system_serial,location,status,problem,time ";
    $sql .= "FROM locations ";
    $sql .= "WHERE tagnumber = '$tagNum' ORDER BY time DESC LIMIT 1";
    foreach ($pdo->query($sql, PDO::FETCH_ASSOC) as $row) {
        $file = new SplFileObject("/tmp/laptop-report-location-".$time.".csv", 'a');
        $file->fputcsv($row);
        $file = null;
    }

}

$pdo = null;
?>
