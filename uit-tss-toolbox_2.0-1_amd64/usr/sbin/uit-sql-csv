#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/mysql-functions');

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d-His');



#Job Table
$file = new SplFileObject("/tmp/laptop-report-job-".$time.".csv", 'w');
dbSelect("CALL iterateJobCSV()");
foreach ($arr as $key => $value) {
    $file->fputcsv($value);
}
$file = null;


#Client Table
$file = new SplFileObject("/tmp/laptop-report-client-".$time.".csv", 'w');
dbSelect("CALL iterateClientCSV()");
foreach ($arr as $key => $value) {
    $file->fputcsv($value);
}
$file = null;


#Server Table
$file = new SplFileObject("/tmp/laptop-report-server-".$time.".csv", 'w');
dbSelect("CALL iterateServerLabels()");
foreach ($arr as $key => $value) {
    $file->fputcsv($value);
}
$file = null;


#Locations Table
$file = new SplFileObject("/tmp/laptop-report-location-".$time.".csv", 'w');
dbSelect("CALL iterateLocationLabels()");
foreach ($arr as $key => $value) {
    $file->fputcsv($value);
}

$sql = "SELECT tagnumber,system_serial,location,status,problem,time FROM locations WHERE time IN (SELECT MAX(time) FROM locations GROUP BY tagnumber)";
dbSelect($sql);
foreach ($arr as $key => $value) {
    $file->fputcsv($value);
}
$file = null;

$pdo = null;
?>