#!/usr/bin/php
<?php
/* "uit-sql-refresh-server" uses PHP to refresh the serverstats table in the mysql database. The
serverstats table is an aggregation of the clientstats table's statistics and also pulls some data
from the jobstats table. serverstats is a historical table. This script iterates through every date
starting at 2023-01-09 (our first database entry) until the current date and updates all of the entries
accordingly. TBW, boot_time, and battry_health are not historical, meaning they only update when the 
script runs and cannot update retroactively if, for example, the serverstats table were to be lost.*/
include('/var/lib/UIT-TSS-TOOLBOX/PDO-connect');
include('/var/lib/UIT-TSS-TOOLBOX/functions');

echo "Updating serverstats" . PHP_EOL;

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

# If the current date does not exist in the DB, then create an entry for the current date with mostly NULL values.
$sql = "SELECT date FROM serverstats WHERE date = '$date'";
$results = $pdo->query($sql);
$linecount = $results->fetchColumn();
if ($linecount == "0") {
        echo "Inserting new serverstats entry for $date." . "\n";
        $sql = "INSERT INTO serverstats(date,time) VALUES ('$date','$time')";
        $pdo->query($sql);
}

# Select all the dates from the serverstats table and iterate through them.
$arr = array();
$sql = "SELECT date FROM serverstats";
foreach ($pdo->query($sql) as $row) {
    $start = hrtime(true);
    $sqlDate = $row['date'];

    /* Update time, which is a datetime stamp. This helps us see the time when the serverstats 
    table was last updated, not just the date. */
    $sql = "UPDATE serverstats SET time = '$time' WHERE date = '$date'";
    $pdo->query($sql);

    /* Update laptop count. A laptop counts as a distinct tagnumber in jobstats.*/
    $sql = "SELECT COUNT(DISTINCT tagnumber) FROM jobstats WHERE (date BETWEEN '2023-01-01' AND '$sqlDate') AND uuid LIKE 'techComm-%'";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE serverstats SET laptop_count = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET laptop_count = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);


    # Update clone_avgtime
    $sql = "SELECT ROUND(AVG(clone_time) / 60, 0) FROM jobstats WHERE clone_completed = 'Yes' AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE serverstats SET clone_avgtime = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET clone_avgtime = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);


    # Update nvme_erase_avgtime
    $sql = "SELECT ROUND(AVG(erase_time) / 60, 0) FROM jobstats WHERE erase_completed = 'yes' AND disk LIKE 'nvme%' AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE serverstats SET nvme_erase_avgtime = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET nvme_erase_avgtime = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);



    # Update sata_erase_avgtime
    $sql = "SELECT ROUND(AVG(erase_time) / 60, 0) FROM jobstats WHERE erase_completed = 'yes' AND disk LIKE 'sd%' AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE serverstats SET sata_erase_avgtime = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET sata_erase_avgtime = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);


    # Update erase_jobs
    $sql = "SELECT COUNT(erase_completed) FROM jobstats WHERE erase_completed = 'Yes' AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $results = $pdo->query($sql);
    $eraseJobsLC = $results->fetchColumn();
    if ($eraseJobsLC > 0) {
        $sql = "UPDATE serverstats SET erase_jobs = '$eraseJobsLC' WHERE date = '$sqlDate'";
    } else {
        $eraseJobsLC = 0;
    }
    $pdo->query($sql);


    # Update clone_jobs
    $sql = "SELECT COUNT(clone_completed) FROM jobstats WHERE clone_completed = 'Yes' AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $results = $pdo->query($sql);
    $cloneJobsLC = $results->fetchColumn();
    if ($cloneJobsLC > 0) {
        $sql = "UPDATE serverstats SET clone_jobs = '$cloneJobsLC' WHERE date = '$sqlDate'";
    } else {
        $cloneJobsLC = 0;
    }


    # Update all_jobs
    $value = $eraseJobsLC + $cloneJobsLC;
    $sql = "UPDATE serverstats SET all_jobs = '$value' WHERE date = '$sqlDate'";
    $pdo->query($sql);


    # Update last_image_update
    $sql = "SELECT date FROM jobstats WHERE clone_master = 'Yes' AND (date BETWEEN '2023-01-09' AND '$sqlDate') ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE serverstats SET last_image_update = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET last_image_update = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);


    # TBW
    $arrDiskWrites = array();
    $sql = "SELECT disk_model,disk_tbw,disk_tbr FROM static_disk_stats";
    foreach ($pdo->query($sql) as $row) {
        $diskTBW = $row["disk_tbw"];
        $diskTBR = $row["disk_tbr"];
        $diskModel = $row["disk_model"];

        $sql = "SELECT AVG(disk_writes) / '$diskTBW' * 100 as disk_writes FROM jobstats WHERE time IN (SELECT MAX(time) FROM jobstats WHERE date BETWEEN '2023-01-09' AND '$sqlDate' ";
        $sql .= "GROUP BY tagnumber) AND disk_model = '$diskModel'";
        $results = $pdo->query($sql);
        $value = $results->fetchColumn();
        if ($value > 0 && filter($value) == 0) {
            $sql = "UPDATE serverstats SET tbw_pcnt = '$value' WHERE date = '$sqlDate'";
        } else {
            $sql = "UPDATE serverstats SET tbw_pcnt = NULL WHERE date = '$sqlDate'";
        }
        $results = $pdo->query($sql);
    }


    #Update boot_time
    $sql = "SELECT boot_time FROM jobstats WHERE boot_time IS NOT NULL AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $sth = $pdo->prepare($sql);
    $sth->execute();
    $arr = $sth->fetchAll(PDO::FETCH_COLUMN);
    $sum = array_sum($arr);
    $linecount = count($arr);
    if ($sum > 0 && $linecount > 0) {
        $value = round($sum / $linecount, 0);
        $sql = "UPDATE serverstats SET boot_time = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET boot_time = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);
    $arr = array();



    #Update battery_health
    $sql = "SELECT battery_health FROM jobstats WHERE battery_health IS NOT NULL AND (date BETWEEN '2023-01-09' AND '$sqlDate')";
    $sth = $pdo->prepare($sql);
    $sth->execute();
    $arr = $sth->fetchAll(PDO::FETCH_COLUMN);
    $sum = array_sum($arr);
    $linecount = count($arr);
    if ($sum > 0 && $linecount > 0) {
        $value = round($sum / $linecount, 0);
        $sql = "UPDATE serverstats SET battery_health = '$value' WHERE date = '$sqlDate'";
    } else {
        $sql = "UPDATE serverstats SET battery_health = NULL WHERE date = '$sqlDate'";
    }
    $pdo->query($sql);
    $arr = array();


    $end = hrtime(true);
    $executionTime = round(($end - $start) / 1e9, 4);
    echo "Updating serverstats for $sqlDate: " . $executionTime . " seconds" . PHP_EOL;
}

# Close the connection
$pdo = null;
?>
