#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/DB-connect-local.php');

$date = date('Y-m-d',time());
$time = date('Y-m-d-His', time());

    $sql = "SELECT 'Job UUID','Tag Number','MAC Address','Date','Time','BIOS Vendor','BIOS Version','BIOS Last Update',";
    $sql .= "'BIOS Revision','BIOS Firmware','System Manufacturer','System Product Name','System Serial Number','System UUID',";
    $sql .= "'System SKU','System Family','Motherboard Manufacturer','Motherboard Serial Number','Chassis Manufcaturer',";
    $sql .= "'Chassis Type','Chassis Serial','Chassis Tag','PSU State','CPU Family','CPU Manufacturer','CPU ID',";
    $sql .= "'CPU Version','CPU Voltage','CPU Max Speed','CPU Current Speed','CPU Cores','CPU Threads','RAM Serial','Battery Manufacturer',";
    $sql .= "'Battery Name','Battery Capacity','Battery Voltage','Battery Serial Number','Battery Manufacture Date','Battery Alarm (Boolean)','Battery Health (Max Charge %)','Battery Charge Cycles','Boot Errors',";
    $sql .= "'Boot Time','Action','Reboot','Disk','Disk Size (GB)','Disk Model','Disk Serial','Disk Firmware','Disk Health Check','Disk Temperature','Disk Reads','Disk Writes',";
    $sql .= "'Max TBW (per the manufacturer)','Total Time','Erase Successful','Erase Mode','Total Erase Time','Percent of Disk Erased',";
    $sql .= "'Clone Successful','Clone Mode','Total Clone Time','Master Image','Clone Server','Clone Image','Last Image Update','Linux User' ";
    $sql .= "\nUNION ALL ";
    $sql .= "\nSELECT * ";
    $sql .= "\nFROM jobstats WHERE NOT tagnumber = '000000' AND NOT tagnumber = '111111' ORDER BY date DESC ";
    $sql .= "\nINTO OUTFILE '/tmp/laptop-report-job-".$time.".csv' ";
    $sql .= "\nFIELDS TERMINATED BY ',' ";
    $sql .= "\nENCLOSED BY '\"' ";
    $sql .= "\nLINES TERMINATED BY '\\n'";

    $conn->query($sql);

    $sql = "SELECT 'Date','Laptop Count','Last Image Update','Total Erase and/or Clone Jobs','Erase Jobs','Clone Jobs','Clone Avg. Time','NVME Avg. Erase Time','SSD Avg. Erase Time','Average Disk Wear Percent (100% is bad)','Average Boot Time'
    UNION ALL
    SELECT date,laptop_count,last_image_update,all_jobs,erase_jobs,clone_jobs,clone_avgtime,nvme_erase_avgtime,ssd_erase_avgtime,tbw_pcnt,boot_time
    FROM serverstats ORDER BY date DESC 
    INTO OUTFILE '/tmp/laptop-report-server-".$time.".csv'
    FIELDS TERMINATED BY ','
    ENCLOSED BY '\"'
    LINES TERMINATED BY '\\n'";

    $conn->query($sql);

    $sql = "SELECT 'Tag Number','Chassis Serial Number','Device Manufacturer','Device Model','Last Job Date',";
    $sql .= "'Average Time for All Operations','Average Time to Erase','Average Time to Clone','Total Jobs (Erase and Clone Jobs)','Total Erase Jobs',";
    $sql .= "'Total Clone Jobs','BIOS Last Update','BIOS Version','Battery Manufacture Date','Battery Health (Current Max Charge %)','TBW (Terabytes Written)','Max TBW', 'Average Boot Time'";
    $sql .= "UNION ALL
    SELECT tagnumber,chassis_serial,device_type,system_productname,last_job_date,all_avgtime,erase_avgtime,clone_avgtime,all_jobs,erase_jobs,clone_jobs,bios_date,bios_version,battery_manufacturedate,battery_health,disk_tbw,max_tbw,boot_time
    FROM clientstats WHERE NOT tagnumber = '000000' AND NOT tagnumber = '111111' ORDER BY 'last_job_date' DESC 
    INTO OUTFILE '/tmp/laptop-report-client-".$time.".csv'
    FIELDS TERMINATED BY ','
    ENCLOSED BY '\"'
    LINES TERMINATED BY '\\n'";
    
    $conn->query($sql);


    #Locations Table
    $sql = "SELECT 'Tagnumber','Serial Number','Location','Status','Problem','Time of Report' UNION ALL SELECT tagnumber,chassis_serial,location,status,problem,time FROM locations WHERE NOT tagnumber = '000000' AND NOT tagnumber = '111111' ORDER BY time DESC LIMIT 1 GROUP BY(tagnumber)";
    $results = $conn->query($sql);
    $arr = array();
    $fp = fopen("/tmp/laptop-report-location-".$time.".csv", 'w');
    while ($row = mysqli_fetch_array($results, MYSQLI_ASSOC)) {
        $arr[] = $row;
        fputcsv($fp, $row);
    }
    fclose($fp);

$conn->close(); 
?>