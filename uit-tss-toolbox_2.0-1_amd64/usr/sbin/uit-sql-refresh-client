#!/usr/bin/php
<?php
# Connect to database and include custom functions
include('/var/lib/UIT-TSS-TOOLBOX/mysql-functions');

# Set current date and time
$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

echo "Updating clientstats" . PHP_EOL;

# Get stdin
$stdin = fopen('php://stdin', 'r');
$line = trim(fgets(STDIN));
fclose($stdin);
# If stdin matches regex, then update that tagnumber, else update all tagnumbers.
if (preg_match("/[0-9]{6}/", $line)) {
    $input = $line;
} else {
    $input = '%';
}

# Iterate through distinct computers in the Tech Commons by tagnumber.
dbSelect("SELECT DISTINCT tagnumber FROM jobstats WHERE tagnumber LIKE '$input' AND uuid LIKE 'techComm-%'");
foreach ($arr as $key => $value) {
    # Start the timer that counts how long it takes to update each tagnumber.
    $start = hrtime(true);

    $tagNum = $row['tagnumber'];

    # If tagnumber does not exist in the clientstats table, then insert it.
    dbSelect("SELECT COUNT(tagnumber) AS result FROM clientstats WHERE tagnumber = '$tagNum'");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        if ($result == "0") {
            echo "Inserting laptop: " . $tagNum . PHP_EOL;
            $sql = "INSERT INTO clientstats(tagnumber) VALUES ('$tagNum')";
            $pdo->query($sql);
        }
    }

    # Update the date of the BIOS release
    dbSelect("SELECT bios_date AS result FROM jobstats WHERE tagnumber = '$tagNum' AND bios_date IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("clone_avgtime", "$result", "$tagNum");
    }

    # Update the BIOS version
    dbSelect("SELECT bios_version AS result FROM jobstats WHERE tagnumber = '$tagNum' AND bios_version IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("bios_version", "$result", "$tagNum");
    }

    # Update the system model
    dbSelect("SELECT system_model AS result FROM jobstats WHERE tagnumber = '$tagNum' AND system_model IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("system_model", "$result", "$tagNum");
    }

    # Update the system serial number
    dbSelect("SELECT system_serial AS result FROM jobstats WHERE tagnumber = '$tagNum' AND system_serial IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("system_serial", "$result", "$tagNum");
    }

    # Update the CPU model
    dbSelect("SELECT cpu_model AS result FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_model IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("cpu_model", "$result", "$tagNum");
    }

    # Update the amount of CPU cores
    dbSelect("SELECT cpu_cores AS result FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_cores IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        dbUpdateCS("cpu_cores", "$result", "$tagNum");
    }

    # Update the average erase times for each client
    dbSelect("SELECT ROUND(AVG(erase_time) / 60, 0) AS result FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        if ($result > 0) {
            dbUpdateCS("erase_avgtime", "$result", "$tagNum");
        } else {
            dbUpdateCS("erase_avgtime", "NULL", "$tagNum");
        }
    }

    # Update the average clone time for each client
    dbSelect("SELECT ROUND(AVG(clone_time) / 60, 0) AS result FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        if ($result > 0) {
            dbUpdateCS("clone_avgtime", "$result", "$tagNum");
        } else {
            dbUpdateCS("clone_avgtime", "NULL", "$tagNum");
        }
    }

    # Update count of total jobs. Total jobs count as every entry of clone_completed or erase_completed equal to "Yes" - One entry can be up to two jobs (clone + erase job).
    dbSelect("SELECT COUNT(tagnumber) AS result FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed= 'Yes')");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        if ($result > 0) {
            dbUpdateCS("all_jobs", "$result", "$tagNum");
        } else {
            dbUpdateCS("all_jobs", "NULL", "$tagNum");
    }

    # Disk Health
    # Get disk model of the client.
    dbSelect("SELECT disk_model AS result FROM jobstats WHERE tagnumber = '$tagNum' AND disk_model IS NOT NULL ORDER BY time LIMIT 1");
    foreach ($arr as $key => $value) {
        $diskModel = $value["result"];
    }
    # Get disk type (ssd/nvme/hdd).
    dbSelect("SELECT disk_type AS result FROM static_disk_stats WHERE disk_model = '$diskModel'");
    foreach ($arr as $key => $value) {
        $diskType = $value["result"];
    }
    if (filter($diskType) == 0 && filter($diskModel) == 0) {
        # Get most recent amount of disk writes.
        dbSelect("SELECT disk_writes AS result FROM jobstats WHERE tagnumber = '$tagNum' AND disk_writes IS NOT NULL ORDER BY time DESC LIMIT 1");
        foreach ($arr as $key => $value) {
            $diskWritesCur = $value["result"];
        }
        # Get maximum amount of disk writes per the drive manufacturer.
        dbSelect("SELECT disk_tbw AS result FROM static_disk_stats WHERE disk_model = '$diskModel'");
        foreach ($arr as $key => $value) {
            $diskWritesMax = $value["result"];
        }
        $diskTBW = 0;
        # If the disk type is an nvme or ssd, then $value is the average of disk writes over disk max writes as a percentage
        if ($diskType == "ssd" || $diskType == "nvme") {
            if ($diskReadsMax > 0 && $diskWritesMax > 0) {
                $diskTBW = round(($diskWritesCur / $diskWritesMax) * 100, 0);
            }
        # If the disk type is hdd
        } elseif ($diskType == "hdd") {
            # Get current disk reads amount
            dbSelect("SELECT disk_reads AS result FROM jobstats WHERE tagnumber = '$tagNum' AND disk_reads IS NOT NULL ORDER BY time DESC LIMIT 1");
            foreach ($arr as $key => $value) {
                $diskReadsCur = $value["result"];
            }
            # Get maximum disk reads amount
            dbSelect("SELECT disk_tbr AS result FROM static_disk_stats WHERE disk_model = '$diskModel'");
            foreach ($arr as $key => $value) {
                $diskReadsMax = $value["result"];
            }
            $diskTBW = 0;
            # $value is the average of the average of disk read amount and disk write amount as a percentage
            if ($diskReadsMax > 0 && $diskWritesMax > 0) {
                $diskTBW = round(((($diskReadsCur / $diskReadsMax) * 100 ) + ((($diskWritesCur / $diskWritesMax) * 100)) / 2), 0);
            }
        }
        # If $value is greater than 0, then set tbw_pcnt to $value, otherwise tbw_pcnt is null;
        if ($diskTBW > 0) {
            dbUpdateCS("tbw_pcnt", "$diskTBW", "$tagNum");
        } else {
            dbUpdateCS("tbw_pcnt", "NULL", "$tagNum");
        }
    # If there is no disk type or disk model, then set tbw_pcnt to null;
    } else {
        dbUpdateCS("tbw_pcnt", "NULL", "$tagNum");
    }

    # Update the type of disk (nvme,ssd,hdd), based on the disk_health block
    dbUpdateCS("disk_type", "$diskType", "$tagNum");

    # Update battery health as a percentage
    dbSelect("SELECT battery_health AS result FROM jobstats WHERE tagnumber = '$tagNum' AND battery_health IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($arr as $key => $value) {
        $result = $value["result"];
        if ($result > 0) {
            dbUpdateCS("battery_health", "$result", "$tagNum");
        } else {
            dbUpdateCS("battery_health", "NULL", "$tagNum");
        }
    }

    # Update boot time in seconds
    dbSelect("SELECT ROUND(AVG(boot_time), 0) AS result FROM jobstats WHERE tagnumber = '$tagNum' AND boot_time IS NOT NULL");
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0 && $value > 0) {
        $sql = "UPDATE clientstats SET boot_time = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET boot_time = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);

    # Update the uuid of the last job (assumed techComm UUIDs because of the iterated values) and the time of the last job.
    dbSelect("SELECT time,uuid FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed = 'Yes') AND date IS NOT NULL ORDER BY time DESC LIMIT 1");
    foreach ($pdo->query($sql) as $row) {
        $lastJobTime = $row["time"];
        $lastUUID = $row["uuid"];
        if (filter($value) == 0) {
            $sql = "UPDATE clientstats SET last_job_time = '$lastJobTime' WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
            $sql = "UPDATE clientstats SET last_job_uuid = '$lastUUID' WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
        } else {
            $sql = "UPDATE clientstats SET last_job_time = NULL WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
            $sql = "UPDATE clientstats SET last_job_uuid = NULL WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
        }
    }

    # Update the system manufacturer
    dbSelect("SELECT system_manufacturer AS result FROM jobstats WHERE tagnumber = '$tagNum' AND system_manufacturer IS NOT NULL ORDER BY time DESC LIMIT 1");
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET system_manufacturer = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET system_manufacturer = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);

    # End the timer and print the time taken to iterate through a client.
    $end = hrtime(true);
    $executionTime = round(($end - $start) / 1e9, 4);
    echo "Updating client $tagNum: " . $executionTime . " seconds" . PHP_EOL;
}

# Disconnect from the DB.
$pdo = null;
?>