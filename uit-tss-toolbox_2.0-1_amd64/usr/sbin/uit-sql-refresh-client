#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/PDO-connect');
include('/var/lib/UIT-TSS-TOOLBOX/functions');

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

$stdin = fopen('php://stdin', 'r');
$line = trim(fgets(STDIN));
fclose($stdin);

global $tagNum;

if (preg_match("/[0-9]{6}/", $line)) {
    $input = $line;
} else {
    $input = '%';
}

$sql = "SELECT DISTINCT tagnumber FROM jobstats WHERE tagnumber LIKE '$input' AND uuid LIKE 'techComm-%'";
foreach ($pdo->query($sql) as $row) {
    $start = hrtime(true);
    $tagNum = $row['tagnumber'];
    $sql = "SELECT COUNT(tagnumber) FROM clientstats WHERE tagnumber = '$tagNum'";
    $results = $pdo->query($sql);
    $linecount = $results->fetchColumn();
    if ($linecount == "0") {
        echo "Inserting laptop: " . $tagNum . PHP_EOL;
        $sql = "INSERT INTO clientstats(tagnumber,device_type,last_job_date,all_lastuuid,";
        $sql .= "all_time,all_avgtime,erase_time,erase_avgtime,clone_time,clone_avgtime,all_jobs,erase_jobs,";
        $sql .= "clone_jobs,disk,disk_type,disk_writes,disk_reads,max_tbw,tbw_pcnt,system_productname,bios_date,bios_version,system_serial,";
        $sql .= "motherboard_serial,cpu_version,cpu_cores,battery_manufacturedate,battery_health,boot_time)";
        $sql .= "VALUES ($tagNum,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,";
        $sql .= "DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT,DEFAULT)";
        $pdo->query($sql);
    }

    #Update disks
    $sql = "SELECT disk FROM jobstats WHERE tagnumber = '$tagNum' AND disk IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET disk = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET disk = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    #Update bios_date
    $sql = "SELECT bios_date FROM jobstats WHERE tagnumber = '$tagNum' AND bios_date IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET bios_date = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET bios_date = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update bios_version
    $sql = "SELECT bios_version FROM jobstats WHERE tagnumber = '$tagNum' AND bios_version IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET bios_version = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET bios_version = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update system_productname
    $sql = "SELECT system_productname FROM jobstats WHERE tagnumber = '$tagNum' AND system_productname IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET system_productname = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET system_productname = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update motherboard_serial
    $sql = "SELECT motherboard_serial FROM jobstats WHERE tagnumber = '$tagNum' AND motherboard_serial IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET motherboard_serial = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET motherboard_serial = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update system_serial
    $sql = "SELECT system_serial FROM jobstats WHERE tagnumber = '$tagNum' AND system_serial IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET system_serial = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET system_serial = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update cpu_version
    $sql = "SELECT cpu_version FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_version IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET cpu_version = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET cpu_version = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update cpu_cores
    $sql = "SELECT cpu_cores FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_cores IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET cpu_cores = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET cpu_cores = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update battery_manufacturedate
    $sql = "SELECT battery_manufacturedate FROM jobstats WHERE tagnumber = '$tagNum' AND battery_manufacturedate IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET battery_manufacturedate = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET battery_manufacturedate = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Erase times
    $sql = "SELECT COUNT(tagnumber) FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'";
    $results = $pdo->query($sql);
    $eraseLineCount = $results->fetchColumn();
    $sql = "SELECT ROUND(SUM(erase_time), 2) FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'";
    $results = $pdo->query($sql);
    $eraseTimeSum = $results->fetchColumn();
    $sql = "UPDATE clientstats SET erase_jobs = '$eraseLineCount' WHERE tagnumber = '$tagNum'";
    $pdo->query($sql);
    if ($eraseLineCount >= 1) {
        $sql = "UPDATE clientstats SET erase_time = '$eraseTimeSum' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
        $sql = "UPDATE clientstats SET erase_avgtime = ROUND('$eraseTimeSum' / '$eraseLineCount' / 60, 0) WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Clone times
    $sql = "SELECT COUNT(tagnumber) FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'";
    $results = $pdo->query($sql);
    $cloneLineCount = $results->fetchColumn();
    $sql = "SELECT ROUND(SUM(clone_time), 2) FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'";
    $results = $pdo->query($sql);
    $cloneTimeSum = $results->fetchColumn();
    # Update total clone jobs
    $sql = "UPDATE clientstats SET clone_jobs = '$cloneLineCount' WHERE tagnumber = '$tagNum'";
    $pdo->query($sql);
    # Avg. Times
    if ($cloneLineCount >= 1) {
        $sql = "UPDATE clientstats SET clone_time = '$cloneTimeSum' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
        $sql = "UPDATE clientstats SET clone_avgtime = ROUND('$cloneTimeSum' / '$cloneLineCount' / 60, 0) WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # All (clone + erase) times
    $allLineCount = $cloneLineCount + $eraseLineCount;
    $allTimeSum = $cloneTimeSum + $eraseTimeSum;
    if ($allLineCount > 0) {
        $allAvgTime = round(($eraseTimeSum * $eraseLineCount) + ($cloneTimeSum * $cloneLineCount) / ($allLineCount), 2);
    } else {
        $allLineCount = 0;
    }
    # Update total jobs
    $sql = "UPDATE clientstats SET all_jobs = '$allLineCount' WHERE tagnumber = '$tagNum'";
    $pdo->query($sql);
    #Avg Times
    if ($allLineCount > 0) {
        $sql = "UPDATE clientstats SET all_time = '$allTimeSum' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
        $avgTimeMin = round($allAvgTime / 60, 2);
        $sql = "UPDATE clientstats SET all_avgtime = '$avgTimeMin' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    # TBW
    $sql = "SELECT disk_model FROM jobstats WHERE tagnumber = '$tagNum' AND disk_model IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (!empty($value)) {
        if ($value == "SSDPEMKF256G8 NVMe INTEL 256GB") {
            $maxTBW='72';
            $diskType='ssd';
        }
        if ($value == "MTFDHBA256TCK-1AS1AABHA") {
            $maxTBW='75';
            $diskType='ssd';
        }
        if ($value == "LITEON CV8-8E128-11 SATA 128GB") {
            $maxTBW='75';
            $diskType='ssd';
        }
        if ($value == "WDC PC SN520 SDAPNUW-256G-1006") {
            $maxTBW='100';
            $diskType='ssd';
        }
        if ($value == "ST500LM034-2GH17A") {
            $maxTBW='55';
            $diskType='hdd';
        }
        #TOSHIBA MQ01ACF050 600k hours mtbf
        if ($value == "TOSHIBA MQ01ACF050") {
            $maxTBW='100';
            $diskType='hdd';
        }
        $sql = "UPDATE clientstats SET max_tbw = '$maxTBW' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $diskType="unknown";
        $sql = "UPDATE clientstats SET max_tbw = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    #Disk type
    if ($diskType != "unknown") {
        $sql = "UPDATE clientstats SET disk_type = '$diskType' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET disk_type = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    #Also TBW
    $sql = "SELECT disk_writes FROM jobstats WHERE tagnumber = '$tagNum' AND disk_writes IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET disk_writes = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET disk_writes = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    #TBR (Terabytes Read)
    $sql = "SELECT disk_reads FROM jobstats WHERE tagnumber = '$tagNum' AND disk_reads IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET disk_reads = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET disk_reads = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Disk Health
    if ($diskType == "ssd") {
        $sql = "SELECT ROUND((disk_writes / max_tbw) * 100, 0) FROM clientstats WHERE tagnumber = '$tagNum' AND max_tbw IS NOT NULL";
    } else {
        $sql = "SELECT ROUND((disk_writes + disk_reads) / max_tbw * 100, 0) FROM clientstats WHERE tagnumber = '$tagNum' AND max_tbw IS NOT NULL";
    }
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0 && $value > 0) {
        $sql = "UPDATE clientstats SET tbw_pcnt = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET tbw_pcnt = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }



    #Battery Health
    $sql = "SELECT battery_health FROM jobstats WHERE tagnumber = '$tagNum' AND battery_health IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET battery_health = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET battery_health = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update boot_time
    $sql = "SELECT COUNT(tagnumber) FROM jobstats WHERE tagnumber = '$tagNum' AND boot_time IS NOT NULL";
    $results = $pdo->query($sql);
    $lineNums = $results->fetchColumn();
    $sql = "SELECT ROUND(SUM(boot_time), 0) FROM jobstats WHERE tagnumber = '$tagNum' AND boot_time IS NOT NULL";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value >= 1 && $lineNums > 0) {
        $value = intdiv($value,$lineNums);
        $sql = "UPDATE clientstats SET boot_time = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET boot_time = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Update all_lastuuid
    $sql = "SELECT uuid FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed = 'Yes') ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET all_lastuuid = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET all_lastuuid = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    # Update last_job_date
    $sql = "SELECT time FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed = 'Yes') ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET last_job_date = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET last_job_date = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Device Type
    $sql = "SELECT system_manufacturer FROM jobstats WHERE tagnumber = '$tagNum' AND system_manufacturer IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET device_type = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET device_type = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    # OS Installed
    $sql = "SELECT clone_completed FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes' AND clone_completed IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET os_installed = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET os_installed = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    $end = hrtime(true);
    $executionTime = round(($end - $start) / 1e9, 4);
    echo "Updating client $tagNum: " . $executionTime . " seconds" . PHP_EOL;
}

$pdo = null;
?>
