#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/PDO-connect');
include('/var/lib/UIT-TSS-TOOLBOX/functions');

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

$stdin = fopen('php://stdin', 'r');
$line = trim(fgets(STDIN));
fclose($stdin);

global $tagNum;

if (preg_match("/[0-9]{6}/", $line)) {
    $input = $line;
} else {
    $input = '%';
}

$sql = "SELECT DISTINCT tagnumber FROM jobstats WHERE tagnumber LIKE '$input' AND uuid LIKE 'techComm-%'";
foreach ($pdo->query($sql) as $row) {
    $start = hrtime(true);
    $tagNum = $row['tagnumber'];
    $sql = "SELECT COUNT(tagnumber) FROM clientstats WHERE tagnumber = '$tagNum'";
    $results = $pdo->query($sql);
    $linecount = $results->fetchColumn();
    if ($linecount == "0") {
        echo "Inserting laptop: " . $tagNum . PHP_EOL;
        $sql = "INSERT INTO clientstats(tagnumber) ";
        $sql .= "VALUES ($tagNum)";
        $pdo->query($sql);
    }

    #Update disks
    $sql = "SELECT disk FROM jobstats WHERE tagnumber = '$tagNum' AND disk IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET disk = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET disk = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }

    #Update bios_date
    $sql = "SELECT bios_date FROM jobstats WHERE tagnumber = '$tagNum' AND bios_date IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET bios_date = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET bios_date = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update bios_version
    $sql = "SELECT bios_version FROM jobstats WHERE tagnumber = '$tagNum' AND bios_version IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET bios_version = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET bios_version = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update system_productname
    $sql = "SELECT system_productname FROM jobstats WHERE tagnumber = '$tagNum' AND system_productname IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET system_productname = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET system_productname = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update system_serial
    $sql = "SELECT system_serial FROM jobstats WHERE tagnumber = '$tagNum' AND system_serial IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET system_serial = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET system_serial = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update cpu_version
    $sql = "SELECT cpu_version FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_version IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET cpu_version = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET cpu_version = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Update cpu_cores
    $sql = "SELECT cpu_cores FROM jobstats WHERE tagnumber = '$tagNum' AND cpu_cores IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET cpu_cores = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET cpu_cores = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Erase times
    $sql = "SELECT ROUND(AVG(erase_time) / 60, 2) FROM jobstats WHERE tagnumber = '$tagNum' AND erase_completed = 'Yes'";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE clientstats SET erase_avgtime = '$value' WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    } else {
        $sql = "UPDATE clientstats SET erase_avgtime = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    # Clone times
    $sql = "SELECT ROUND(AVG(clone_time) / 60, 2) FROM jobstats WHERE tagnumber = '$tagNum' AND clone_completed = 'Yes'";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE clientstats SET clone_avgtime = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET clone_avgtime = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);

    # Update total jobs
    $sql = "SELECT COUNT(tagnumber) FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed= 'Yes')";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if ($value > 0) {
        $sql = "UPDATE clientstats SET all_jobs = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET all_jobs = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);

    # Disk Health
    $sql = "SELECT disk_model FROM jobstats WHERE tagnumber = '$tagNum' AND disk_model IS NOT NULL ORDER BY time LIMIT 1";
    $results = $pdo->query($sql);
    $diskModel = $results->fetchColumn();
    $sql = "SELECT disk_type FROM static_disk_stats WHERE disk_model = '$diskModel'";
    $results = $pdo->query($sql);
    $diskType = $results->fetchColumn();
    if (filter($diskType) == 0 && filter($diskModel) == 0) {
        #disk writes
        $sql = "SELECT disk_writes FROM jobstats WHERE tagnumber = '$tagNum' AND disk_writes IS NOT NULL ORDER BY time DESC LIMIT 1";
        $results = $pdo->query($sql);
        $diskWritesCur = $results->fetchColumn();
        $sql = "SELECT disk_tbw FROM static_disk_stats WHERE disk_model = '$diskModel'";
        $results = $pdo->query($sql);
        $diskWritesMax = $results->fetchColumn();
        $value = 0;
        if ($diskType == "ssd" || $diskType == "nvme") {
            if ($diskReadsMax > 0 && $diskWritesMax > 0) {
                $value = round(($diskWritesCur / $diskWritesMax) * 100, 0);
            }
        } elseif ($diskType == "hdd") {
            #disk reads
            $sql = "SELECT disk_reads FROM jobstats WHERE tagnumber = '$tagNum' AND disk_reads IS NOT NULL ORDER BY time DESC LIMIT 1";
            $results = $pdo->query($sql);
            $diskReadsCur = $results->fetchColumn();
            $sql = "SELECT disk_tbr FROM static_disk_stats WHERE disk_model = '$diskModel'";
            $results = $pdo->query($sql);
            $diskReadsMax = $results->fetchColumn();
            $value = 0;
            if ($diskReadsMax > 0 && $diskWritesMax > 0) {
                $value = round(((($diskReadsCur / $diskReadsMax) * 100 ) + ((($diskWritesCur / $diskWritesMax) * 100)) / 2), 0);
            }
        }
        if ($value > 0) {
            $sql = "UPDATE clientstats SET tbw_pcnt = '$value' WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
        } else {
            $sql = "UPDATE clientstats SET tbw_pcnt = NULL WHERE tagnumber = '$tagNum'";
            $pdo->query($sql);
        }
    } else {
        $sql = "UPDATE clientstats SET tbw_pcnt = NULL WHERE tagnumber = '$tagNum'";
        $pdo->query($sql);
    }


    #Disk type
    if (filter($diskType) == 0) {
        $sql = "UPDATE clientstats SET disk_type = '$diskType' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET disk_type = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    #Battery Health
    $sql = "SELECT battery_health FROM jobstats WHERE tagnumber = '$tagNum' AND battery_health IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0 && $value != 0) {
        $sql = "UPDATE clientstats SET battery_health = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET battery_health = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    #Update boot_time
    $sql = "SELECT ROUND(AVG(boot_time), 0) FROM jobstats WHERE tagnumber = '$tagNum' AND boot_time IS NOT NULL";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0 && $value > 0) {
        $sql = "UPDATE clientstats SET boot_time = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET boot_time = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    # Update last_job_uuid
    $sql = "SELECT uuid FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed = 'Yes') ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET last_job_uuid = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET last_job_uuid = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    # Update last_job_date
    $sql = "SELECT time FROM jobstats WHERE tagnumber = '$tagNum' AND (clone_completed = 'Yes' OR erase_completed = 'Yes') ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET last_job_date = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET last_job_date = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    # System Manufacturer
    $sql = "SELECT system_manufacturer FROM jobstats WHERE tagnumber = '$tagNum' AND system_manufacturer IS NOT NULL ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET device_type = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET device_type = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);

    # OS Installed
    $sql = "SELECT clone_completed FROM jobstats WHERE tagnumber = '$tagNum' AND all_time > 1 ORDER BY time DESC LIMIT 1";
    $results = $pdo->query($sql);
    $value = $results->fetchColumn();
    if (filter($value) == 0) {
        $sql = "UPDATE clientstats SET os_installed = '$value' WHERE tagnumber = '$tagNum'";
    } else {
        $sql = "UPDATE clientstats SET os_installed = NULL WHERE tagnumber = '$tagNum'";
    }
    $pdo->query($sql);


    $end = hrtime(true);
    $executionTime = round(($end - $start) / 1e9, 4);
    echo "Updating client $tagNum: " . $executionTime . " seconds" . PHP_EOL;
}

$pdo = null;
?>