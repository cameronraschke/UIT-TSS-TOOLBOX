#!/bin/bash

/usr/bin/chmod 750 /usr/sbin/uit-*
/usr/bin/chown root:uit /usr/sbin/uit-*

if [[ ! -d /srv/nfs/UIT-TSS-TOOLBOX/images ]]; then
    mkdir -p /srv/nfs/UIT-TSS-TOOLBOX/images
fi
find /srv/nfs/ -type d -exec chmod 755 {} \;
#find /srv/nfs/UIT-TSS-TOOLBOX/images -type d -exec chmod 755 {} \;
#find /srv/nfs/UIT-TSS-TOOLBOX/images -type f -exec chmod 664 {} \;
/usr/bin/chown nobody:nogroup /srv/nfs/UIT-TSS-TOOLBOX/images -R

/usr/bin/chown root:uit /etc/opt/UIT-TSS-TOOLBOX -R
find /etc/opt/UIT-TSS-TOOLBOX -type d -exec chmod 750 {} \;
find /etc/opt/UIT-TSS-TOOLBOX -type f -exec chmod 660 {} \;

/usr/bin/chown root:uit /var/www/html/management -R
find /var/www/html/management -type d -exec chmod 755 {} \;
find /var/www/html/management -type f -exec chmod 664 {} \;
chown www-data:uit /var/www/html/management/bash/uit-print-pdf
chmod 750 /var/www/html/management/bash/uit-print-pdf

if [[ ! -d /srv/UIT-TSS-TOOLBOX/client/src/ ]]; then
    mkdir /srv/UIT-TSS-TOOLBOX/client/src/
fi
if [[ ! -d /srv/UIT-TSS-TOOLBOX/client/pkg/ ]]; then
    mkdir /srv/UIT-TSS-TOOLBOX/client/pkg/
fi
if [[ ! -d /srv/UIT-TSS-TOOLBOX/client/iso/ ]]; then
    mkdir /srv/UIT-TSS-TOOLBOX/client/iso/
fi
if [[ ! -d /srv/UIT-TSS-TOOLBOX/client/netboot/ ]]; then
    mkdir /srv/UIT-TSS-TOOLBOX/client/netboot/
fi
if [[ ! -d /srv/UIT-TSS-TOOLBOX/client/netboot/tftp ]]; then
    mkdir /srv/UIT-TSS-TOOLBOX/client/netboot/tftp
fi

/usr/bin/chown root:uit /srv/UIT-TSS-TOOLBOX/client/src -R
/usr/bin/chown root:uit /srv/UIT-TSS-TOOLBOX/client/pkg -R
/usr/bin/chown root:uit /srv/UIT-TSS-TOOLBOX/client/netboot/ -R
# Find command w/ directory is different regex
find /srv/UIT-TSS-TOOLBOX/ -type d -not -path "*/iso*" -exec chmod 755 {} \;
find /srv/UIT-TSS-TOOLBOX/ -type f -not -path "*/iso/*" -exec chmod 664 {} \;
echo -e "\n" >> /etc/cron.d/uit-cron

DB_ADMIN_PASSWD=$(cat /home/cameron/.uit-passwd | grep '^DB_ADMIN_PASSWD=' | sed 's/DB_ADMIN_PASSWD=//g')
if [[ -f /home/cameron/.my.cnf ]]; then 
 DB_ADMIN_PASSWD=$(cat /home/cameron/.my.cnf | grep '^password=' | sed 's/password=//g')
fi
#DB_CLIENT_PASSWD=$(cat /home/cameron/.uit-passwd | grep '^DB_CLIENT_PASSWD=' | sed 's/DB_CLIENT_PASSWD=//g')
DB_CLIENT_PASSWD=$(openssl rand 10 | hexdump | sed 's/[[:space:]]//g' | head -n1)
echo ${DB_CLIENT_PASSWD} > /home/cameron/test-client-passwd
#DB_WEB_PASSWD=$(cat /home/cameron/.uit-passwd | grep '^DB_WEB_PASSWD=' | sed 's/DB_WEB_PASSWD=//g')
DB_WEB_PASSWD=$(openssl rand 10 | hexdump | sed 's/[[:space:]]//g' | head -n1)
DB_WEB_USER_PASSWD=$(cat /home/cameron/.uit-passwd | grep '^DB_WEB_USER_PASSWD=' | sed 's/DB_WEB_USER_PASSWD=//g')

mysql --database='laptopDB' --execute="ALTER USER 'cameron'@'localhost' IDENTIFIED BY '${DB_ADMIN_PASSWD}';"
mysql --database='laptopDB' --execute="ALTER USER 'uitclient'@'10.0.0.0/255.255.0.0' IDENTIFIED BY '${DB_CLIENT_PASSWD}';"
mysql --database='laptopDB' --execute="ALTER USER 'uitweb'@'localhost' IDENTIFIED BY '${DB_WEB_PASSWD}';"
mysql --database='laptopDB' --execute="UPDATE logins SET username = MD5(username);"
mysql --database='laptopDB' --execute="UPDATE logins SET password = MD5('${DB_WEB_USER_PASSWD}');"

# Insert include.php with modifications to the clients.
cat /var/www/html/management/php/include.php | sed 's/localhost/10.0.0.1/g' | sed 's/uitweb/uitclient/g' > /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/opt/UIT-TSS-TOOLBOX/include.php

sed --in-place "s/UHouston!/${DB_ADMIN_PASSWD}/g" /usr/sbin/uit-backup
sed --in-place "s/UHouston!/${DB_ADMIN_PASSWD}/g" /usr/sbin/uit-sql-report
sed --in-place "s/UHouston!/${DB_CLIENT_PASSWD}/g" /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/usr/sbin/uit-tss-client
sed --in-place "s/UHouston!/${DB_CLIENT_PASSWD}/g" /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/opt/UIT-TSS-TOOLBOX/include.php
sed --in-place "s/UHouston!/${DB_WEB_PASSWD}/g" /var/www/html/management/locations.php
sed --in-place "s/UHouston!/${DB_WEB_PASSWD}/g" /var/www/html/management/api/endpoint.php
sed --in-place "s/UHouston!/${DB_WEB_PASSWD}/g" /var/www/html/management/bash/uit-print-pdf
sed --in-place "s/UHouston!/${DB_WEB_PASSWD}/g" /var/www/html/management/php/include.php
sed --in-place "s/UHouston!/${DB_WEB_PASSWD}/g" /var/www/html/management/php/print-page.php


(cd /srv/UIT-TSS-TOOLBOX/client/src/
chmod 755 /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/DEBIAN/
chmod 755 /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/DEBIAN/control
chmod 755 /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64/DEBIAN/postinst
dpkg-deb --build --root-owner-group /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64 
mv -v /srv/UIT-TSS-TOOLBOX/client/src/uit-tss-client_2.0-1_amd64.deb /srv/UIT-TSS-TOOLBOX/client/pkg/uit-tss-client_2.0-1_amd64.deb 
)

chown dnsmasq:root /srv/UIT-TSS-TOOLBOX/client/netboot/tftp -R
find /srv/UIT-TSS-TOOLBOX/client/netboot/tftp -type f -exec chmod 644 {} \;

mysql laptopDB < /etc/opt/UIT-TSS-TOOLBOX/server/mysql/mysql-procedures.sql
mysql laptopDB < /etc/opt/UIT-TSS-TOOLBOX/server/mysql/mysql-tables.sql

if [[ ! -f /var/www/html/management/favicon.ico ]]; then
    wget 'https://uh.edu/favicon.ico' --output-document /var/www/html/management/favicon.ico
fi

if [[ ! -f  /var/www/html/management/images/uh-logo.png ]]; then
    wget 'http://www.sa.uh.edu/brand/_img/uh-wide-full-color-rgb.png' --output-document=/var/www/html/management/images/uh-logo.png
fi

rsync -Pav --delete /home/cameron/laptop-pictures/ /var/www/html/management/images/

rsync -Pav --delete /home/cameron/jquery /var/www/html/management/

rsync -Pav --delete /home/cameron/google-charts /var/www/html/management/
