#!/usr/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/PDO-connect');
include('/var/lib/UIT-TSS-TOOLBOX/functions');

$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

$stdin = fopen('php://stdin', 'r');
$line = trim(fgets(STDIN));

$arr = explode('|', $line);

if ($arr[0] == "location") {
    $tagNum = $arr[1];
    $serial = $arr[2];
    $location = $arr[3];
    $status = $arr[4];
    $problem = $arr[5];

    $uuid = uniqid("location-", true);

    #Not the same insert statment as client parse code, ether address is DEFAULT here.
    $sql = "INSERT INTO jobstats(uuid,tagnumber,date,time) ";
    $sql .= "VALUES ('$uuid','$tagNum','$date','$time')";
    $pdo->query($sql);


    # INSERT statement
    $sql = "INSERT INTO locations(tagnumber,system_serial,location,status,problem,time) ";
    $sql .= "VALUES (:tagnumber, :system_serial, :location, :status, :problem, :time)";
    $stmt = $pdo->prepare($sql);
    $stmt->bindParam(':tagnumber', $tagNum, PDO::PARAM_STR);
    $stmt->bindParam(':time', $time, PDO::PARAM_STR);


    # Update empty values to NULL
    if (filter($location) == 1) {
        $stmt->bindParam(':location', $location, PDO::PARAM_NULL);
    } else {
        $stmt->bindParam(':location', $location, PDO::PARAM_STR);
    }

    if (filter($status) == 1) {
        $stmt->bindParam(':status', $status, PDO::PARAM_NULL);
    } else {
        $stmt->bindParam(':status', $status, PDO::PARAM_STR);
    }

    if (filter($problem) == 1) {
        $stmt->bindParam(':problem', $problem, PDO::PARAM_NULL);
    } else {
        $stmt->bindParam(':problem', $problem, PDO::PARAM_STR);
    }

    if (filter($serial) == 1) {
        $stmt->bindParam(':system_serial', $serial, PDO::PARAM_NULL);
    } else {
        $stmt->bindParam(':system_serial', $serial, PDO::PARAM_STR);
    }

    $stmt->execute();
    $stmt = null;
}

$pdo = null;

?>