#!/bin/php
<?php
include('/var/lib/UIT-TSS-TOOLBOX/DB-connect-local.php');

$date = date('Y-m-d',time());
$time = date('Y-m-d H:i:s', time());

$stdin = fopen('php://stdin', 'r');
$line = trim(fgets(STDIN));
fclose($stdin);

$arr = explode(',', $line);

if ($arr[0] == "init") {
    $uuid = $arr[1];
    $tagNum = $arr[2];
    $macAddr = $arr[3];
    $default = "N/A";
    $stmt = $conn->prepare("INSERT INTO jobstats(uuid,tagnumber,etheraddress,date,time,bios_vendor,bios_version,bios_date,bios_revision,bios_firmware,system_manufacturer,system_productname,system_serial,system_uuid,system_sku,system_family,motherboard_manufacturer,motherboard_serial,chassis_manufacturer,chassis_type,chassis_serial,chassis_tag,chassis_psu,cpu_family,cpu_manufacturer,cpu_id,cpu_version,cpu_voltage,cpu_maxspeed,cpu_currentspeed,cpu_cores,cpu_threads,ram_serial,battery_manufacturer,battery_name,battery_capacity,battery_voltage,battery_serial,battery_manufacturedate,battery_alarm,battery_health,battery_charge_cycles,boot_errors,boot_time,action,reboot,disk,disksizegb,disk_model,disk_serial,disk_firmware,disk_health,disk_temp,disk_reads,disk_writes,max_tbw,all_time,erase_completed,erase_mode,erase_time,erase_diskpercent,clone_completed,clone_mode,clone_time,clone_master,clone_server,clone_image,clone_imageupdate,clone_sambauser) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)");
    $stmt->bind_param("sssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss", $uuid,$tagNum,$macAddr,$date,$time,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default,$default);
    $stmt->execute();
} elseif ($arr[0] == "disk") {
    $sql = "UPDATE jobstats SET ".$arr[1]." = '".$arr[3]."' WHERE uuid = '".$arr[2]."'";
    $conn->query($sql);
} elseif ($arr[0] == "battery") {
    $sql = "UPDATE jobstats SET ".$arr[1]." = '".$arr[3]."' WHERE uuid = '".$arr[2]."'";
    $conn->query($sql);
} elseif ($arr[0] == "memory") {
    $sql = "UPDATE jobstats SET ".$arr[1]." = '".$arr[3]."' WHERE uuid = '".$arr[2]."'";
    $conn->query($sql);
} elseif ($arr[0] == "dmi") {
    $sql = "UPDATE jobstats SET ".$arr[1]." = '".$arr[3]."' WHERE uuid = '".$arr[2]."'";
    $conn->query($sql);
} elseif ($arr[0] == "boot") {
    $sql = "UPDATE jobstats SET ".$arr[1]." = '".$arr[3]."' WHERE uuid = '".$arr[2]."'";
    $conn->query($sql);
} elseif ($arr[0] == "update") {
    system("echo $arr[1] | uit-tss-sql-refresh-client", $return);
}




?>