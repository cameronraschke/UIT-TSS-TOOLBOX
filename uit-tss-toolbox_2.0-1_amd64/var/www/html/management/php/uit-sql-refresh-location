<?php
# Connect to database and include custom functions
include('/mysql/mysql-functions');

# Set current date and time
$dt = new DateTimeImmutable();
$date = $dt->format('Y-m-d');
$time = $dt->format('Y-m-d H:i:s.v');

# Clear globals
clearSQLGlobals();
clearTimeGlobals();

# Iterate through distinct tagnumbers from jobstats with techComm UUIDs
dbSelect("SELECT tagnumber FROM jobstats WHERE tagnumber IS NOT NULL GROUP BY tagnumber");
foreach ($arr as $key => $value) {
    # Set $tagNum to the iterated tagnumber.
    $tagNum = $value["tagnumber"];

    dbSelectVal("SELECT MAX(time) AS result FROM locations WHERE tagnumber = '$tagNum'");
    $maxTime = $result;

    /* Select the time of the most recent entry for a given client where the clone job has successfully completed. 
    This shows whether or not the OS is installed and at what time it was last installed. */
    $sql = "SELECT erase_completed,clone_completed FROM jobstats WHERE tagnumber = '$tagNum' AND (erase_completed = '1' OR clone_completed = '1') ORDER BY time DESC LIMIT 1";
    dbSelect($sql);
    foreach ($arr as $key => $value) {
        $eraseCompleted = $value["erase_completed"];
        $cloneCompleted = $value["clone_completed"];
        if ($eraseCompleted == '1' && $cloneCompleted == '1') {
            $osInstalled = 1;
        } elseif ($eraseCompleted == '1' && $cloneCompleted != '1') {
            $osInstalled = 0;
        } elseif ($eraseCompleted != '1' && $cloneCompleted == '1') {
            $osInstalled = 1;
        } else {
            $osInstalled = 0;
        }

        dbUpdateLocation("os_installed", "$osInstalled", "$maxTime");
    }
}


# Clear globals
clearSQLGlobals();
clearTimeGlobals();

?>